#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.join('vendor', 'waw', 'lib'))
require 'rubygems'
require 'waw'
Waw.load_application('.')

buffer = STDOUT

def generate_js(path, action)
<<-THEEND
function #{action.public_id}() {
  form = "form##{action.public_id}";
  $.ajax({type: "POST", url: "#{path}/#{action.public_id}", data: $(form).serialize(), dataType: "json",
    error: function(data) {
		  window.location = '/feedback?mkey=server_error'
		},
		success: function(data) {
#{action.routing.generate_js_routing(action, 6)}
		}
	});
	return false;
}  
THEEND
end

buffer << <<-EOF
/* This file is automatically generated by Waw. Any edit will probably be lost
 * next time the application is started. */

EOF

buffer << "/* Messages, from waw.resources.messages */\n"
if Waw.resources.has_resource?(:messages)
  buffer << "var messages = new Array();\n"
  Waw.resources.messages.each do |name, value|
    buffer << "messages['#{name}'] = \"#{value}\";\n"    
  end
end

Waw.resources.services.each do |name, srv|
  next unless Waw::Services::JSONServices===srv
  srv.mapped.keys.sort{|k1, k2| k1.to_s <=> k2.to_s}.each do |path|
    controller = srv.mapped[path]
    
buffer << <<-EOF


/*
 * Actions contributed by #{controller.class}
 */
EOF
    
    controller.actions.keys.sort{|k1, k2| k1.to_s <=> k2.to_s}.each do |name|
      action = controller.actions[name]
      buffer << generate_js(path, action).gsub(/\t/, "  ")
    end
  end
end

