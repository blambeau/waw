wawaccess do
  
  # We don't inherits static configuration
  inherits false
  
  # By default, we deny the call
  strategy :deny_all
  
  # When a folder is requested, find the associated index file
  match directory do
    apply "#{served_file}/index.wtpl"
  end

  # We match .wtpl files using wlang
  match file(:extension => '.wtpl') do
    context = {"css_files"   => Dir[File.join('public', 'css', '*.css')].collect{|s| File.join('css', File.basename(s))},
               "js_files"    => Dir[File.join('public', 'js', '*.js')].collect{|s| File.join('js', File.basename(s))},
               "page"        => served_file,
               "env"         => Waw.env,
               "request"     => Waw.request, 
               "response"    => Waw.response,
               "session"     => Waw.session}
    Waw.resources.each {|k, v| context[k.to_s] = v}
    template = File.join(folder, '../templates/layout.wtpl')
    contents = WLang.file_instantiate(template, context)
    [200, {'Content-Type' => 'text/html'}, [contents]]
  end
  
  # When the file cannot be found
  match true do
    if /\.wtpl$/ =~ served_file
      apply "pages/404.wtpl", 404
    else
      apply "#{served_file}.wtpl"
    end
  end
  
end